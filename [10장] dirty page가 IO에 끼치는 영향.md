# 10.1 dirty pageë€

ë¦¬ëˆ…ìŠ¤ì—ì„œ íŒŒì¼ I/Oê°€ ì¼ì–´ë‚  ë•Œ ì»¤ë„ì€ PageCacheë¥¼ ì´ìš©í•´ì„œ ë””ìŠ¤í¬ì— ìˆëŠ” íŒŒì¼ì˜ ë‚´ìš©ì„ ë©”ëª¨ë¦¬ì— ì ì‹œ ì €ì¥í•˜ê³ , í•„ìš”í•  ë•Œë§ˆë‹¤ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•´ì„œ ì‚¬ìš©í•œë‹¤. ì´ë¥¼ í†µí•´ ë””ìŠ¤í¬ë³´ë‹¤ ë” ë¹ ë¥¸ ë©”ëª¨ë¦¬ì˜ ì ‘ê·¼ ì†ë„ë¥¼ í™œìš©í•  ìˆ˜ ìˆê³  ì „ì²´ì ìœ¼ë¡œ ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

ê·¸ë¦¼ì„ ë³´ë©´ ê°ê° a, b, c íŒŒì¼ì´ PageCacheì— ì˜¬ë¼ê°€ ìˆìœ¼ë©° 1:1ë¡œ ëŒ€ì‘í•˜ê³  ìˆë‹¤. ì´ ìƒíƒœì—ì„œ b íŒŒì¼ì— ì“°ê¸° ì‘ì—…ì´ ì´ë£¨ì–´ì¡Œë‹¤ê³  ê°€ì •í•´ë³´ì. b íŒŒì¼ì˜ ë‚´ìš©ì´ bê°€ ì•„ë‹ˆë¼ dë¡œ ë°”ë€Œì—ˆìœ¼ë©°, ì´ ìƒíƒœì—ì„œ ë³´ë©´ b íŒŒì¼ì˜ ë‚´ìš©ì€ ë””ìŠ¤í¬ì™€ PageCacheì— ìˆëŠ” ë‚´ìš©ì´ ì„œë¡œ ë‹¤ë¥´ë‹¤. ê·¸ë˜ì„œ **ì»¤ë„ì€ í•´ë‹¹ ë©”ëª¨ë¦¬ ì˜ì—­ì— ëŒ€í•´ ë””ìŠ¤í¬ì— ìˆëŠ” ë‚´ìš©ê³¼ ë‹¬ë¼ì¡ŒìŒì„ í‘œì‹œí•˜ëŠ” Dirty ë¹„íŠ¸ë¥¼ ì¼œê³  ë°”ë¡œ ì´ ì˜ì—­ì€ dirty pageë¼ê³  ë¶€ë¥¸ë‹¤.** ì¦‰, dirty pageëŠ” **PageCacheì— ìˆëŠ” í˜ì´ì§€ ì¤‘ì—ì„œë„ ì“°ê¸° ì‘ì—…ì´ ì´ë£¨ì–´ì§„ ë©”ëª¨ë¦¬**ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. ì´ ìƒíƒœì—ì„œëŠ” ì•„ì§ PageCacheì™€ ë””ìŠ¤í¬ ì‚¬ì´ì˜ ë‚´ìš©ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì „ì› ì¥ì•  ë“±ìœ¼ë¡œ ì‹œìŠ¤í…œì´ êº¼ì ¸ ë²„ë¦°ë‹¤ë©´ ë¯¸ì²˜ ë””ìŠ¤í¬ì— ì“°ì§€ ëª»í•œ ë‚´ìš©ì€ ë‚ ì•„ê°€ê²Œ ë˜ë©° íŒŒì¼ì˜ ë‚´ìš©ì— ëŒ€í•œ ì •í•©ì„±ì´ ê¹¨ì§€ê²Œ ëœë‹¤. í•˜ì§€ë§Œ dirty pageë¡œ í‘œì‹œëœ ë©”ëª¨ë¦¬ë“¤ì„ dirty pageê°€ ìƒì„±ë  ë•Œë§ˆë‹¤ ë””ìŠ¤í¬ì— ì“°ë©´ ì´ ë˜í•œ ìƒë‹¹ëŸ‰ì˜ ì“°ê¸° I/Oë¥¼ ì¼ìœ¼ì¼œì„œ ì„±ëŠ¥ì„ ì €í•˜ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

**ê·¸ë˜ì„œ ì»¤ë„ì€ ëª‡ ê°€ì§€ ì¡°ê±´ì„ ë§Œë“¤ì–´ì„œ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±ì‹œí‚¤ë©´ dirty pageë¥¼ ë””ìŠ¤í¬ë¡œ ë™ê¸°í™”í•œë‹¤. ì´ ê³¼ì •ì„ page writebackì´ë¼ê³  ë¶€ë¥´ë©° dirty page ë™ê¸°í™”**ë¼ê³ ë„ í•œë‹¤(ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì€ ë””ìŠ¤í¬ì˜ ë°ì´í„°ë¥¼ ìºì‹±í•˜ëŠ”ë°, ì´ë¥¼ í˜ì´ì§€ ìºì‹œ(page cache)ë¼ê³  í•˜ê³ , ìºì‹œë˜ì–´ ìˆë˜ í˜ì´ì§€ê°€ ë‹¤ì‹œ ë””ìŠ¤í¬ë¡œ ì ìš©ë˜ëŠ” ê²ƒ(ë™ê¸°í™” ë˜ëŠ” ê²ƒ)ì„ page writebackì´ë¼ê³  í•œë‹¤.). ì»¤ë„ ë²„ì „ì— ë”°ë¼ì„œ ë‹¤ë¥´ê² ì§€ë§Œ ë³´í†µ flushë¼ëŠ” ë‹¨ì–´ê°€ ë“¤ì–´ê°„ ì»¤ë„ ìŠ¤ë ˆë“œ(pdflush, flush, bdflush ë“±)ê°€ ì´ ì‘ì—…ì„ ì§„í–‰í•œë‹¤. ê·¸ë˜ì„œ **I/Oê°€ ë§ì´ ë°œìƒí•˜ëŠ” ì„œë²„ì—ì„œëŠ” dirty pageë¥¼ ì–¸ì œ ì–¼ë§ˆë‚˜ ë™ê¸°í™” ì‹œí‚¤ëŠëƒê°€ ì¤‘ìš”í•œ ì„±ëŠ¥ íŠœë‹ì˜ ìš”ì†Œ**ê°€ ëœë‹¤. ê·¸ë¦¬ê³  ì»¤ë„ì—ì„œëŠ” ì„œë²„ì˜ ì›Œí¬ë¡œë“œì— ë”°ë¼ ê°€ì¥ ì í•©í•œ ë™ê¸°í™” ì „ëµì„ êµ¬ì‚¬í•  ìˆ˜ ìˆë„ë¡ íŒŒë¼ë¯¸í„°ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ê³  ìˆë‹¤.

ì´ ì§ˆë¬¸ ì§„ì§œ ì˜í–ˆë‹¤ ğŸ‘

ì—¬ê¸°ì„œ í—·ê°ˆë¦¬ë©´ page cache ê°œë…ì´ ì™„ì „íˆ ê¼¬ì—¬.

---

# ğŸ”¥ í•µì‹¬ ë¨¼ì €

> â— dirty pageëŠ”
> 
> 
> **ë””ìŠ¤í¬ë³´ë‹¤ ë©”ëª¨ë¦¬(page cache)ê°€ ìµœì‹  ìƒíƒœì¼ ë•Œ ìƒê¸´ë‹¤**
> 

ê·¸ë˜ì„œ

> âœ… ë™ê¸°í™”ëŠ” â€œë©”ëª¨ë¦¬ â†’ ë””ìŠ¤í¬â€ ë°©í–¥ì´ë‹¤
> 
> 
> âŒ ë””ìŠ¤í¬ â†’ ìºì‹œê°€ ì•„ë‹ˆë‹¤
> 

---

# ğŸ§  êµ¬ì¡°ë¥¼ ì •í™•íˆ ë³´ì

ë¦¬ëˆ…ìŠ¤ íŒŒì¼ I/O íë¦„ì€ ì´ë ‡ê²Œ ëœë‹¤:

```
ë””ìŠ¤í¬  <---->  í˜ì´ì§€ ìºì‹œ(ë©”ëª¨ë¦¬)  <---->  í”„ë¡œì„¸ìŠ¤
```

---

## 1ï¸âƒ£ íŒŒì¼ì„ ì½ì„ ë•Œ

1. ë””ìŠ¤í¬ â†’ ë©”ëª¨ë¦¬(page cache)ë¡œ ì˜¬ë¼ì˜´
2. í”„ë¡œì„¸ìŠ¤ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ì½ìŒ

ğŸ‘‰ ì´ë•ŒëŠ” clean page

---

## 2ï¸âƒ£ íŒŒì¼ì„ ì“¸ ë•Œ

ì˜ˆ:

```c
write(fd, "hello", 5);
```

ì´ê²Œ ë°œìƒí•˜ë©´:

1. ë””ìŠ¤í¬ì— ë°”ë¡œ ì“°ì§€ ì•ŠìŒ
2. í˜ì´ì§€ ìºì‹œì— ë¨¼ì € ì”€
3. ë©”ëª¨ë¦¬ ë‚´ìš©ì´ ë””ìŠ¤í¬ì™€ ë‹¬ë¼ì§

ğŸ‘‰ ì´ ìƒíƒœê°€ ë°”ë¡œ **dirty page**

---

# ğŸ“Œ ê·¸ëŸ¬ë©´ ì™œ ë””ìŠ¤í¬ë¡œ ë™ê¸°í™”í•˜ëƒ?

ì™œëƒë©´

> ë””ìŠ¤í¬ê°€ ì˜êµ¬ ì €ì¥ì†Œì´ê¸° ë•Œë¬¸
> 

ë©”ëª¨ë¦¬ëŠ”:

- ì „ì› ë„ë©´ ë‚ ì•„ê°
- ì»¤ë„ íŒ¨ë‹‰ ë‚˜ë©´ ë‚ ì•„ê°

ê·¸ë˜ì„œ

> ê²°êµ­ì€ ë””ìŠ¤í¬ì— ë°˜ì˜í•´ì•¼ ì•ˆì „í•¨
> 

---

# ğŸ’¥ ë„¤ê°€ í—·ê°ˆë¦° ë¶€ë¶„

> â€œìºì‹œë‘ ë””ìŠ¤í¬ê°€ ë‹¤ë¥´ë©´ ìºì‹œë¥¼ ë””ìŠ¤í¬ì— ë§ì¶°ì•¼ í•˜ëŠ” ê±° ì•„ë‹ˆì•¼?â€
> 

ì•„ë‹ˆì•¼.

ë¦¬ëˆ…ìŠ¤ëŠ” **write-back ìºì‹œ ì „ëµ**ì„ ì“´ë‹¤.

ì¦‰:

- ë©”ëª¨ë¦¬ê°€ ì§„ì§œ ë°ì´í„°
- ë””ìŠ¤í¬ëŠ” ë‚˜ì¤‘ì— ë”°ë¼ê°

---

# ğŸ¯ ì™œ ì´ë ‡ê²Œ ì„¤ê³„í–ˆì„ê¹Œ?

### ì´ìœ  1ï¸âƒ£ ì„±ëŠ¥

ë””ìŠ¤í¬ëŠ” ëŠë¦¼

ë©”ëª¨ë¦¬ëŠ” ë¹ ë¦„

ë§¤ writeë§ˆë‹¤ ë””ìŠ¤í¬ ì“°ë©´ ì„œë²„ í„°ì§

ê·¸ë˜ì„œ:

- ë©”ëª¨ë¦¬ì— ìŒ“ì•„ë‘ê³ 
- í•œ ë²ˆì— ë¬¶ì–´ì„œ ë””ìŠ¤í¬ë¡œ ì”€

â†’ ì´ê²Œ page writeback

---

# ğŸ§© ê·¸ë˜ì„œ dirty page ë™ê¸°í™” ì „ëµì´ ì¤‘ìš”

ì»¤ë„ì€ ì´ëŸ° ê¸°ì¤€ìœ¼ë¡œ flushí•¨:

- dirty ë¹„ìœ¨ì´ ì¼ì • % ë„˜ìœ¼ë©´
- ì¼ì • ì‹œê°„ ì§€ë‚˜ë©´
- ë©”ëª¨ë¦¬ ë¶€ì¡±í•˜ë©´
- sync/fsync í˜¸ì¶œë˜ë©´

---

# ğŸ”§ ê´€ë ¨ íŠœë‹ íŒŒë¼ë¯¸í„°

í™•ì¸í•´ë´:

```bash
sysctl -a | grep dirty
```

ì¤‘ìš”í•œ ê²ƒë“¤:

```
vm.dirty_ratio
vm.dirty_background_ratio
vm.dirty_expire_centisecs
vm.dirty_writeback_centisecs
```

---

# ğŸ”¥ ìš”ì•½ í•œ ë¬¸ì¥

> dirty pageëŠ” ë©”ëª¨ë¦¬ê°€ ë” ìµœì‹ ì´ê¸° ë•Œë¬¸ì—
> 
> 
> ê²°êµ­ ë””ìŠ¤í¬ë¥¼ ë©”ëª¨ë¦¬ ìƒíƒœë¡œ ë§ì¶°ì£¼ëŠ” ê³¼ì •ì´ writebackì´ë‹¤.
> 

---

# ğŸ“ í•œ ì¤„ ë¹„ìœ 

ë””ìŠ¤í¬ = ê³µì‹ ê¸°ë¡ë¶€

ë©”ëª¨ë¦¬ = ìˆ˜ì • ì¤‘ì¸ ì´ˆì•ˆ

dirty page = ì•„ì§ ê¸°ë¡ë¶€ì— ë°˜ì˜ ì•ˆ ëœ ìˆ˜ì •ë³¸

writeback = ì´ˆì•ˆì„ ê³µì‹ ê¸°ë¡ë¶€ì— ì˜®ê¸°ëŠ” ê³¼ì •

---

ì›í•˜ë©´ ë‚´ê°€:

- dirty_ratioê°€ ë‚®ìœ¼ë©´ ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì§€ëŠ”ì§€
- write-heavy ì„œë²„ì—ì„œ dirty íŠœë‹ ì „ëµ
- DB ì„œë²„ì—ì„œ ì™œ O_DIRECTë¥¼ ì“°ëŠ”ì§€

ê¹Œì§€ ì´ì–´ì„œ ì •ë¦¬í•´ì¤„ê¹Œ?

# 10.2 dirty page ê´€ë ¨ ì»¤ë„ íŒŒë¼ë¯¸í„°

```yaml
root@ip-172-31-0-19:/home/ubuntu# sysctl -a | grep -i dirty
vm.dirty_background_bytes = 0
vm.dirty_background_ratio = 10
vm.dirty_bytes = 0
vm.dirty_expire_centisecs = 3000
vm.dirty_ratio = 20
vm.dirty_writeback_centisecs = 500
vm.dirtytime_expire_seconds = 43200
```

## vm.dirty_background_ratio

**dirty pageì˜ ë‚´ìš©ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ ë™ê¸°í™”í•  ë•Œ ê·¸ ê¸°ì¤€ì´ ë˜ëŠ” ë¹„ìœ¨ì„ ì˜ë¯¸í•œë‹¤.** ì „ì²´ ë©”ëª¨ë¦¬ ì–‘ì— í•´ë‹¹ íŒŒë¼ë¯¸í„°ì— ì„¤ì •ë˜ì–´ ìˆëŠ” ë¹„ìœ¨ì„ ê³±í•´ì„œ ë‚˜ì˜¨ ê¸°ì¤€ ê°’ë³´ë‹¤ dirty pageì˜ í¬ê¸°ê°€ ì»¤ì§€ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ dirty pageì˜ ë‚´ìš©ì„ ë””ìŠ¤í¬ë¡œ ë™ê¸°í™”í•œë‹¤. ë§Œì•½ ì´ ê°’ì´ 10ì´ê³  ì „ì²´ ë©”ëª¨ë¦¬ê°€ 16GBë¼ê³  ê°€ì •í•œë‹¤ë©´, dirty pageì˜ í¬ê¸°ê°€ 1.6GBê°€ ë˜ì—ˆì„ ë•Œ ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ë¥¼ ì§„í–‰í•œë‹¤.

## vm.dirty_background_bytes

ratioê°€ ì „ì²´ ë©”ëª¨ë¦¬ ëŒ€ë¹„ ë¹„ìœ¨ì„ ì˜ë¯¸í•˜ì§€ë§Œ, bytesëŠ” ì ˆëŒ€ì ì¸ bytesì˜ ê°’ì„ ì˜ë¯¸í•œë‹¤. ë§Œì•½ ì´ ê°’ì´ 65535ë¼ë©´ dirty pageì˜ í¬ê¸°ê°€ 65535bytesê°€ ë˜ì—ˆì„ ë•Œ ë™ê¸°í™”í•œë‹¤.

## vm.dirty_ratio

ì „ì²´ ë©”ëª¨ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ dirty pageì˜ ë¹„ìœ¨ì„ ì‚°ì •í•˜ì§€ë§Œ backgroundë¼ëŠ” ë‹¨ì–´ê°€ ë¹ ì ¸ ìˆìŒì„ ëˆˆì—¬ê²¨ë´ì•¼ í•œë‹¤. ë§Œì•½ ì´ ê°’ì´ 10ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆê³  ì „ì²´ ë©”ëª¨ë¦¬ê°€ 16GBë¼ê³  ê°€ì •í•˜ë©´, Aë¼ëŠ” í”„ë¡œì„¸ìŠ¤ê°€ I/O ì‘ì—…ì„ í•˜ë˜ ì¤‘ dirty í˜ì´ì§€ì˜ í¬ê¸°ê°€ 1.6GBê°€ ë˜ë©´ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ I/O ì‘ì—…ì„ ëª¨ë‘ ë©ˆì¶”ê²Œ í•˜ê³  dirty pageë¥¼ ë™ê¸°í™”í•œë‹¤.

## vm.dirty_bytes

`vm.dirty_ratio` ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ë§Œ ë¹„ìœ¨ì´ ì•„ë‹ˆë¼ ì ˆëŒ€ì ì¸ bytes ì–‘ì„ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.

## vm.dirty_writeback_centisecs

flush ì»¤ë„ ìŠ¤ë ˆë“œë¥¼ ëª‡ ì´ˆ ê°„ê²©ìœ¼ë¡œ ê¹¨ìš¸ ê²ƒì¸ì§€ë¥¼ ê²°ì •í•œë‹¤. ì„¤ì •ë˜ëŠ” ê°’ì€ 1/100ì´ˆ ê°’ì´ê¸° ë•Œë¬¸ì— 5ì´ˆë¡œ ì„¤ì •í•˜ê³  ì‹¶ë‹¤ë©´ 500 * (1/100)ìœ¼ë¡œ í‘œì‹œí•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ 5ì´ˆì— í•œ ë²ˆ flush ì»¤ë„ ìŠ¤ë ˆë“œê°€ êº ì–´ë‚˜ì„œ ë™ê¸°í™”í•˜ê²Œ ëœë‹¤.

## vm.dirty_expire_centisecs

ì´ ê°’ë„ flush ì»¤ë„ ìŠ¤ë ˆë“œì˜ ë™ì‘ì— ì˜í–¥ì„ ë¯¸ì¹œë‹¤. `vm.dirty_writeback_centisecs` ê°’ì— ì˜í•´ êº ì–´ë‚œ flush ì»¤ë„ ìŠ¤ë ˆë“œê°€ ë””ìŠ¤í¬ì— ì‹±í¬ì‹œí‚¬ dirty pageì˜ ê¸°ì¤€ì„ ì°¾ì„ ë•Œ ì´ ê°’ì„ ì‚¬ìš©í•œë‹¤. ì´ ê°’ë„ 1/100ì´ˆ ê°’ì´ë©° ë§Œì•½ 3000ìœ¼ë¡œ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ 30ì´ˆë¥¼ ì˜ë¯¸í•œë‹¤. ê·¸ë˜ì„œ dirty pageë¡œ ë¶„ë¥˜ëœ í›„ 30ì´ˆ ë™ì•ˆ ë””ìŠ¤í¬ë¡œ ë™ê¸°í™”ë˜ì§€ ì•Šì€ í˜ì´ì§€ë“¤ì„ ë””ìŠ¤í¬ì— ë™ê¸°í™”ì‹œí‚¨ë‹¤.

# 10.3 ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”

## ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”

ë™ê¸°í™” ì‘ì—…ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ì§„í–‰ë˜ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. ì»¤ë„ íŒŒë¼ë¯¸í„° ì¤‘ì— `vm.dirty_background_ratio`ì™€ `vm.dirty_ratio`ë¥¼ í†µí•´ì„œ ì¡°ì ˆí•  ìˆ˜ ìˆë‹¤. ì—„ë°€íˆ ë§í•˜ë©´ `vm.dirty_ratio` ê°’ì„ ë„˜ì–´ì„°ì„ ë•Œ ë°œìƒí•˜ëŠ” ë™ê¸°í™”ëŠ” ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ê°€ ì•„ë‹ˆì§€ë§Œ, ëª…ë ¹ì–´ì— ì˜í•´ ëª…ì‹œì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ëŠ” ë™ê¸°í™”ëŠ” ì•„ë‹ˆê¸° ë•Œë¬¸ì— í•¨ê»˜ ë¶„ë¥˜í–ˆë‹¤. ì´ ì‘ì—…ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ dirty pageë¥¼ ìƒì„±í•  ë•Œë§ˆë‹¤ í˜„ì¬ê¹Œì§€ ìƒì„±ëœ dirty pageì™€ ì „ì²´ ë©”ëª¨ë¦¬ì˜ ë¹„ìœ¨ì„ ë°”íƒ•ìœ¼ë¡œ ì§„í–‰ëœë‹¤.

## ì£¼ê¸°ì ì¸ ë™ê¸°í™”

ë™ê¸°í™” ì‘ì—…ì´ ì£¼ê¸°ì ìœ¼ë¡œ ì§„í–‰ë˜ëŠ” ê²ƒì„ ë§í•œë‹¤. ì»¤ë„ íŒŒë¼ë¯¸í„° ì¤‘ì— `vm.dirty_writeback_centisec`, `vm.dirty_expire_centisecs`ë¥¼ í†µí•´ì„œ ì¡°ì ˆí•  ìˆ˜ ìˆë‹¤. ì´ ê°’ë“¤ì„ ì¡°ì ˆí•´ì„œ dirty pageë¥¼ ë™ê¸°í™”í•˜ê¸° ìœ„í•´ í•„ìš”í•œ flush ë°ëª¬ì„ ê¹¨ìš°ëŠ” ì£¼ê¸°ì™€ ê¹¨ì› ì„ ë•Œ ë™ê¸°í™”ì‹œí‚¤ëŠ” dirty pageì˜ ê¸°ì¤€ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

## ëª…ì‹œì ì¸ ë™ê¸°í™”

ëª…ì‹œì ìœ¼ë¡œ ë™ê¸°í™”ì‹œí‚¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. sync, fsync ë“±ì˜ ëª…ë ¹ì„ ì´ìš©í•˜ë©´ í˜„ì¬ ìƒì„±ë˜ì–´ ìˆëŠ” dirty pageë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë””ìŠ¤í¬ì— ì“°ëŠ”ë°, ì´ëŸ° ì‘ì—…ì„ ëª…ì‹œì ì¸ ë™ê¸°í™”ë¼ê³  í‘œí˜„í•œë‹¤.

ì´ë²ˆ ì ˆì—ì„œëŠ” ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ì™€ ì£¼ê¸°ì ì¸ ë™ê¸°í™”ë¥¼ ì‚´í´ë³¼ ê²ƒì´ë‹¤. ì»¤ë„ì˜ ë™ì‘ì„ ì¶”ì í•˜ê¸° ìœ„í•´ ìš°ì„  ftraceë¥¼ ì´ìš©í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ì„¤ì •í•œë‹¤.

```yaml
ubuntu@ip-172-31-0-19:~$ sudo su
root@ip-172-31-0-19:/home/ubuntu# mount -t debugfs debugfs /sys/kernel/debug
mount: /sys/kernel/debug: debugfs already mounted on /sys/kernel/debug.
root@ip-172-31-0-19:/home/ubuntu# cd /sys/kernel/debug/tracing/
root@ip-172-31-0-19:/sys/kernel/debug/tracing# echo function > ./current_tracer
root@ip-172-31-0-19:/sys/kernel/debug/tracing# cat -v ./trace_pipe
   kworker/u30:0-11      [000] .....  2051.367456: wq_worker_running <-schedule
   kworker/u30:0-11      [000] .....  2051.367456: kthread_data <-wq_worker_running
   kworker/u30:0-11      [000] .....  2051.367456: _raw_spin_lock_irq <-worker_thread
   kworker/u30:0-11      [000] d....  2051.367456: process_one_work <-worker_thread
   kworker/u30:0-11      [000] d....  2051.367456: kick_pool <-process_one_work
   kworker/u30:0-11      [000] .....  2051.367456: flush_to_ldisc <-process_one_work
   kworker/u30:0-11      [000] .....  2051.367456: mutex_lock <-flush_to_ldisc
   kworker/u30:0-11      [000] .....  2051.367456: __cond_resched <-mutex_lock
```

ë¨¼ì € ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ë¥¼ ì‚´í´ë³´ê¸° ìœ„í•´ ì£¼ê¸°ì ì¸ ë™ê¸°í™”ê°€ ì¼ì–´ë‚˜ì§€ ì•Šë„ë¡ `vm.dirty_writeback_centisecs` ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •í•œë‹¤. ê·¸ë¦¬ê³  ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ê°€ ì¡°ê¸ˆ ë” ë¹¨ë¦¬ ì¼ì–´ë‚  ìˆ˜ ìˆë„ë¡ `vm.dirty_background_ratio` ê°’ì€ 1ë¡œ ì„¤ì •í•œë‹¤.

```yaml
ubuntu@ip-172-31-0-19:~$ sudo su
root@ip-172-31-0-19:/home/ubuntu# sysctl -w vm.dirty_writeback_centisecs=0
vm.dirty_writeback_centisecs = 0
root@ip-172-31-0-19:/home/ubuntu# sysctl -w vm.dirty_background_ratio=1
vm.dirty_background_ratio = 1
```

```yaml
root@ip-172-31-0-19:/home/ubuntu# ./dirty_page 
Write File - Current Size : 1024 KB
Write File - Current Size : 2048 KB
Write File - Current Size : 3072 KB
Write File - Current Size : 4096 KB
Write File - Current Size : 5120 KB
Write File - Current Size : 6144 KB
Write File - Current Size : 7168 KB
Write File - Current Size : 8192 KB
Write File - Current Size : 9216 KB
Write File - Current Size : 10240 KB
Write File - Current Size : 11264 KB
root@ip-172-31-0-19:/home/ubuntu# ./show_dirty.sh 
Dirty:              6352 kB
Dirty:              5956 kB
Dirty:              6356 kB
Dirty:              6496 kB
Dirty:              5956 kB
Dirty:              6356 kB
Dirty:              6308 kB
Dirty:              6384 kB
Dirty:              6492 kB
Dirty:              6096 kB
```

```yaml
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6616 kB
Dirty:              6384 kB
Dirty:              6736 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6476 kB
Dirty:              6392 kB
Dirty:              6384 kB
Dirty:              6652 kB
Dirty:              6400 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6484 kB
Dirty:              5984 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6404 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6592 kB
Dirty:              5980 kB
Dirty:              6384 kB
Dirty:              6384 kB
Dirty:              6084 kB
Dirty:              6384 kB
Dirty:              6384 kB

# ë„ˆë¬´ ì»¤ì„œ ë³¼ ìˆ˜ê°€ ì—†ë‹¤ ã… ã… 
root@ip-172-31-0-19:/sys/kernel/debug/tracing# cat -v ./trace_pipe | grep balance_dirty_pages
cat: ./trace_pipe: Device or resource busy
```

í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë³´ë©´ 64MBë¥¼ ì¡°ê¸ˆ ë„˜ê¸´ í›„ì— ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ê°€ ì¼ì–´ë‚˜ì„œ dirty pageê°€ ì—†ì–´ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì—¬ê¸°ì„œ ì¬ë°ŒëŠ” í•¨ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `balance_dirty_pages_ratelimited_nr()` í•¨ìˆ˜ì™€ `balance_dirty_pages()`ë¼ëŠ” í•¨ìˆ˜ê°€ ë³´ì¸ë‹¤. ftraceì˜ ê²°ê³¼ë¥¼ `grep balance_dirty_pages` ëª…ë ¹ìœ¼ë¡œ í•„í„°ë§í•´ë³´ë©´ ë‹¤ìˆ˜ì˜ `balance_dirty_pages_ratelimited_nr()` í•¨ìˆ˜ê°€ í˜¸ì¶œëœ í›„ ì¤‘ê°„ ì¤‘ê°„ì— `balance_dirty_pages()` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ” íŒ¨í„´ì´ë‹¤. ê·¸ë¦¬ê³  `balance_dirty_pages_rattelimited_nr()` í•¨ìˆ˜ëŠ” `generic_file_buffered_write()` í•¨ìˆ˜ì— ì˜í•´ í˜¸ì¶œëœë‹¤. ê·¸ë˜ì„œ dirty pageë¥¼ ìƒì„±í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ë“¤ì€ ì“°ê¸° ì‘ì—…ì´ ì´ë£¨ì–´ì§ˆ ë•Œë§ˆë‹¤ `balance_dirty_pages_ratelimited_nr()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ë©°, ì´ í•¨ìˆ˜ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `balance_dirty_pages()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.